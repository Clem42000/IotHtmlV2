<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Surveillance IoT ‚Äì Gestion de Stock</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Police -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1d35 100%);
            color: #e0e6ed;
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }

        /* Header */
        header {
            background: linear-gradient(135deg, #1e2742 0%, #2a3251 100%);
            padding: 20px 24px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            margin-bottom: 20px;
            border: 1px solid rgba(96, 165, 250, 0.2);
        }
        header h1 { font-size: 26px; font-weight: 700; color: #60a5fa; margin-bottom: 4px; }
        header p { color: #94a3b8; font-size: 13px; font-weight: 300; }

        /* Tabs */
        .tabs{ margin-top:16px; display:flex; gap:10px; }
        .tab-btn{
            border-radius:999px; padding:8px 18px; font-size:13px;
            border:1px solid rgba(148,163,184,0.4);
            background:rgba(15,23,42,0.8); color:#cbd5f5;
            cursor:pointer; transition:.2s;
        }
        .tab-btn.active{
            background:#2563eb; color:white;
            border-color:#60a5fa; box-shadow:0 0 18px rgba(37,99,235,.6);
        }
        .tab-content{ margin-top:20px; }
        .tab-panel{ display:none; }
        .tab-panel.active{ display:block; }

        .dashboard-grid{
            display:grid;
            grid-template-columns:repeat(auto-fit,minmax(320px,1fr));
            gap:20px; margin-bottom:25px;
        }

        /* Cards */
        .card{
            background:linear-gradient(135deg,#1e2742,#252d47);
            border-radius:15px;
            padding:18px 20px;
            border:1px solid rgba(96,165,250,.15);
            box-shadow:0 8px 32px rgba(0,0,0,.35);
        }
        .card h3{
            font-size:17px; font-weight:600;
            margin-bottom:10px; color:#60a5fa;
        }

        /* Camera */
        .camera-preview{
            width:100%; height:260px;
            background:#0f172a; border-radius:12px;
            display:flex; align-items:center; justify-content:center;
            overflow:hidden;
            border:2px solid rgba(96,165,250,.25);
            margin-bottom:10px;
        }
        .camera-preview img{
            width:100%; height:100%; object-fit:contain;
        }
        .placeholder{ color:#64748b; font-size:14px; text-align:center; }

        .cam-metrics{
            margin-top:10px; padding:10px;
            border-radius:10px;
            background:rgba(15,23,42,.9);
            border:1px solid rgba(96,165,250,.25);
            display:grid;
            grid-template-columns:repeat(auto-fit,minmax(140px,1fr));
            gap:10px; font-size:12px;
        }
        .cam-metric-label{
            font-size:10px; letter-spacing:.08em;
            color:#64748b; text-transform:uppercase;
        }
        .cam-metric-value{ font-weight:600; }

        /* Stats globales */
        .stats-grid{
            display:grid;
            grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
            gap:18px; margin-bottom:20px;
        }
        .stat-card{
            background:linear-gradient(135deg,#1e2742,#252d47);
            border-radius:15px; padding:20px; text-align:center;
        }
        .stat-label{ font-size:11px; color:#64748b; text-transform:uppercase; }
        .stat-value{ font-size:30px; font-weight:700; color:#60a5fa; margin-top:6px; }

        .progress-bar{ width:100%; height:8px; background:#101626; border-radius:10px; overflow:hidden; margin-top:10px; }
        .progress-fill{ height:100%; background:linear-gradient(90deg,#22c55e,#10b981); width:0%; transition:.4s; }

        /* IA block (nouveau) */
        .ia-grid{
            margin-top:12px;
            display:grid;
            grid-template-columns:repeat(auto-fit,minmax(140px,1fr));
            gap:12px;
            padding-top:10px;
            border-top:1px solid rgba(255,255,255,0.08);
        }
        .ia-item{
            background:rgba(15,23,42,0.6);
            padding:10px; border-radius:10px;
            border:1px solid rgba(51,65,85,.5);
            text-align:center;
        }
        .ia-label{
            font-size:11px; color:#64748b;
            text-transform:uppercase; margin-bottom:4px;
        }
        .ia-value{ font-size:20px; font-weight:600; color:#e5e7eb; }

            </style>
</head>

<body>
<div class="container">
    <header>
        <h1>üé• Surveillance IoT ‚Äì Gestion de Stock</h1>
        <p>Raspberry Pi ¬∑ WebSocket temps r√©el ¬∑ InvenTree ¬∑ ESP32-CAM ¬∑ IA embarqu√©e</p>

        <!-- Onglets -->
        <div class="tabs">
            <button class="tab-btn active" data-tab="surveillance">Surveillance</button>
            <button class="tab-btn" data-tab="config">Configuration palettes</button>
        </div>
    </header>

    <div class="tab-content">

        <!-- ========================================================= -->
        <!-- ===================== TAB SURVEILLANCE ================== -->
        <!-- ========================================================= -->
        <section id="tab-surveillance" class="tab-panel active">

            <!-- ====== STATISTIQUES GLOBALES ====== -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Colis total d√©tect√©s</div>
                    <div class="stat-value" id="stat-total">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Nombre de palettes</div>
                    <div class="stat-value" id="stat-palettes">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Taux de remplissage</div>
                    <div class="stat-value" id="stat-fill">0%</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="fill-progress"></div>
                    </div>
                </div>
            </div>

            <!-- ====== CAMERA + STATUT SYSTEME ====== -->
            <div class="dashboard-grid dashboard-main">

                <!-- ====== CAMERA ====== -->
                <div class="card camera-card">
                    <h3>Cam√©ra entrep√¥t</h3>

                    <div class="camera-preview">
                        <img id="camera-stream"
                             src="http://192.168.100.182:5000/video_feed"
                             alt="Flux cam√©ra"
                             style="display:none;">
                        <div class="placeholder" id="camera-placeholder">
                            Connexion au flux vid√©o‚Ä¶<br>
                            http://192.168.100.182:5000/video_feed
                        </div>
                    </div>

                    <div id="camera-status"
                         style="margin-top:8px; font-size:13px; color:#9ca3af;">
                         Statut cam√©ra : <span id="camera-status-value">‚è≥ V√©rification‚Ä¶</span>
                    </div>

                    <!-- ====== METRIQUES CAMERA / WS ====== -->
                    <div class="cam-metrics">
                        <div><span class="cam-metric-label">WebSocket</span>
                             <span class="cam-metric-value" id="ws-status">‚è≥ Connexion‚Ä¶</span>
                        </div>
                        <div><span class="cam-metric-label">Dernier message WS</span>
                             <span class="cam-metric-value" id="ws-last-msg">‚Äî</span>
                        </div>
                        <div><span class="cam-metric-label">Derni√®re maj palettes</span>
                             <span class="cam-metric-value" id="ws-last-palettes">‚Äî</span>
                        </div>
                        <div><span class="cam-metric-label">Flux vid√©o</span>
                             <span class="cam-metric-value" id="cam-stream-status">En cours‚Ä¶</span>
                        </div>
                    </div>
                </div>

                <!-- ====== STATUT SYSTEME ====== -->
                <div class="card">
                    <h3>Statut & sp√©cifications syst√®me</h3>
<!-- ===================================================== -->
<!-- ========== üëáüëá  BLOC IA √Ä AJOUTER  üëáüëá -->
<!-- ===================================================== -->
<h3 style="margin-top:18px; font-size:15px; color:#93c5fd;">
    üì¶ Analyse IA en direct (ESP32-CAM)
</h3>

<div class="ia-grid">
    <div class="ia-item">
        <div class="ia-label">Cartons d√©tect√©s</div>
        <div class="ia-value" id="ia-cartons">‚Äî</div>
    </div>
    <div class="ia-item">
        <div class="ia-label">FPS IA</div>
        <div class="ia-value" id="ia-fps">‚Äî</div>
    </div>
    <div class="ia-item">
        <div class="ia-label">Images analys√©es</div>
        <div class="ia-value" id="ia-framecount">‚Äî</div>
    </div>
    <div class="ia-item">
        <div class="ia-label">Motif utilis√©</div>
        <div class="ia-value" id="ia-motif">‚Äî</div>
    </div>
    <div class="ia-item">
        <div class="ia-label">Motifs valides</div>
        <div class="ia-value" id="ia-valid">‚Äî</div>
    </div>
    <div class="ia-item">
        <div class="ia-label">Verdict IA</div>
        <div class="ia-value" id="ia-verdict">‚Äî</div>
    </div>
</div>

                    <div class="specs-grid">
                        <div class="info-item">
                            <label>Latence WebSocket typique</label>
                            <div class="value">‚âà 18 ms</div>
                        </div>
                        <div class="info-item">
                            <label>Cycle de mise √† jour stock</label>
                            <div class="value">2 s</div>
                        </div>
                        <div class="info-item">
                            <label>Latence API InvenTree</label>
                            <div class="value">&lt; 80 ms</div>
                        </div>
                        <div class="info-item">
                            <label>Disponibilit√© cible</label>
                            <div class="value">99,95 %</div>
                        </div>
                        <div class="info-item">
                            <label>Plateforme</label>
                            <div class="value">Raspberry Pi ¬∑ Python ¬∑ WebSockets</div>
                        </div>
                        <div class="info-item">
                            <label>Flux cam√©ra</label>
                            <div class="value">ESP32-CAM ¬∑ 720p</div>
                        </div>
                    </div>

                    <div class="spec-note">Perfomances en direct du serveur et des flux.</div>

                    <!-- ===================================================== -->
                    <!-- ========== üëáüëá  NOUVEAU BLOC IA SOUS LE RESTE  üëáüëá -->
                    <!-- ===================================================== -->
                    <h3 style="margin-top:18px; font-size:15px; color:#93c5fd;">
                        üì¶ Analyse IA en direct (ESP32-CAM)
                    </h3>

                    <div class="ia-grid">
                        <div class="ia-item">
                            <div class="ia-label">Cartons d√©tect√©s</div>
                            <div class="ia-value" id="ia-cartons">‚Äî</div>
                        </div>
                        <div class="ia-item">
                            <div class="ia-label">FPS IA</div>
                            <div class="ia-value" id="ia-fps">‚Äî</div>
                        </div>
                        <div class="ia-item">
                            <div class="ia-label">Images analys√©es</div>
                            <div class="ia-value" id="ia-framecount">‚Äî</div>
                        </div>
                        <div class="ia-item">
                            <div class="ia-label">Motif utilis√©</div>
                            <div class="ia-value" id="ia-motif">‚Äî</div>
                        </div>
                        <div class="ia-item">
                            <div class="ia-label">Motifs valides</div>
                            <div class="ia-value" id="ia-valid">‚Äî</div>
                        </div>
                        <div class="ia-item">
                            <div class="ia-label">Verdict IA</div>
                            <div class="ia-value" id="ia-verdict">‚Äî</div>
                        </div>
                    </div>
                    <!-- FIN BLOC IA -->
                </div>
            </div>
            <!-- ============ PALETTES INVENTREE ============ -->
            <h3 style="margin: 10px 2px 8px;">Palettes & contenu (InvenTree)</h3>
            <div class="dashboard-grid" id="palettes-container">
                <!-- Rempli dynamiquement -->
            </div>

        </section>

        <!-- ========================================================= -->
        <!-- ===================== TAB CONFIGURATION ================= -->
        <!-- ========================================================= -->
        <section id="tab-config" class="tab-panel">
            <p class="config-help">
                Ici tu d√©finis <strong>la r√©partition attendue</strong> des cartons par palette.<br>
                Le syst√®me v√©rifiera ensuite en temps r√©el et affichera ‚úî/‚ùå dans l‚Äôonglet
                <em>Surveillance</em>.
            </p>

            <div class="dashboard-grid" id="config-container"></div>

            <button class="config-save-all" id="btn-save-config">
                üíæ Enregistrer la configuration
            </button>
        </section>
    </div>
</div>

<!-- ============================================================== -->
<!-- =============== SCRIPT JAVASCRIPT COMPLET ==================== -->
<!-- ============================================================== -->
<script>

//////////////////////////////////////////////////////////////
// VARIABLES GLOBALES
//////////////////////////////////////////////////////////////
const ws = new WebSocket("ws://192.168.100.112:8765");

let lastPalettes = [];
let palettesConfig = {};
let lastWsMessageTime = null;

//////////////////////////////////////////////////////////////
// ONGLET
//////////////////////////////////////////////////////////////
document.querySelectorAll(".tab-btn").forEach(btn => {
    btn.addEventListener("click", () => {
        const tab = btn.getAttribute("data-tab");

        document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
        document.querySelectorAll(".tab-panel").forEach(p => p.classList.remove("active"));

        btn.classList.add("active");
        document.getElementById("tab-" + tab).classList.add("active");

        if (tab === "config") renderConfigTab();
    });
});

//////////////////////////////////////////////////////////////
// CAMERA EVENT LISTENERS
//////////////////////////////////////////////////////////////
const camImg = document.getElementById("camera-stream");
const camPlaceholder = document.getElementById("camera-placeholder");

camImg.onload = () => {
    camImg.style.display = "block";
    camPlaceholder.style.display = "none";
    document.getElementById("cam-stream-status").textContent = "Flux actif";
};

camImg.onerror = () => {
    camImg.style.display = "none";
    camPlaceholder.style.display = "block";
    camPlaceholder.innerHTML = "Flux indisponible<br>192.168.100.182:5000";
    document.getElementById("cam-stream-status").textContent = "Erreur flux";
};

setInterval(() => {
    camImg.src = "http://192.168.100.182:5000/video_feed?ts=" + Date.now();
}, 20000);

//////////////////////////////////////////////////////////////
// WEBSOCKET INVENTREE
//////////////////////////////////////////////////////////////
ws.onopen = () => {
    setWsStatus("üü¢ Connect√©", "#4ade80");
    lastWsMessageTime = new Date();
    updateWsLastMessage();
};

ws.onerror = () => setWsStatus("üî¥ Erreur", "#ef4444");
ws.onclose = () => setWsStatus("üî¥ D√©connect√©", "#ef4444");

ws.onmessage = (event) => {
    lastWsMessageTime = new Date();
    updateWsLastMessage();

    const msg = JSON.parse(event.data);
    if (!msg.inventree || !msg.inventree.palettes) return;

    lastPalettes = msg.inventree.palettes;
    document.getElementById("ws-last-palettes").textContent = new Date().toLocaleTimeString();

    updateDashboard();
};

function setWsStatus(text, color) {
    const el = document.getElementById("ws-status");
    el.textContent = text;
    el.style.color = color;
}

function updateWsLastMessage() {
    const el = document.getElementById("ws-last-msg");
    el.textContent = lastWsMessageTime ? lastWsMessageTime.toLocaleTimeString() : "‚Äî";
}

//////////////////////////////////////////////////////////////
// CONFIG LOCALSTORAGE
//////////////////////////////////////////////////////////////
function loadConfig() {
    try {
        palettesConfig = JSON.parse(localStorage.getItem("palettesConfig")) || {};
    } catch {
        palettesConfig = {};
    }
}
loadConfig();

function saveConfig() {
    localStorage.setItem("palettesConfig", JSON.stringify(palettesConfig));
    alert("Configuration enregistr√©e !");
}

//////////////////////////////////////////////////////////////
// COMPARAISON CONFIG / REEL
//////////////////////////////////////////////////////////////
function computeComplianceForPalette(p) {
    const name = p.name;
    const expected = palettesConfig[name] || {};
    const actual = {};

    (p.items || []).forEach(it => {
        const n = it.name;
        actual[n] = (actual[n] || 0) + Number(it.qty || it.quantity || 0);
    });

    const errors = [];
    let ok = true;

    Object.keys(expected).forEach(key => {
        const exp = expected[key];
        const act = actual[key] || 0;

        if (act < exp) {
            ok = false;
            errors.push(`Manque ${exp - act} √ó ${key}`);
        }
        if (act > exp) {
            ok = false;
            errors.push(`${act - exp} √ó ${key} en trop`);
        }
    });

    Object.keys(actual).forEach(key => {
        if (!(key in expected)) {
            ok = false;
            errors.push(`Carton non pr√©vu : ${key} (x${actual[key]})`);
        }
    });

    let status = "unknown";
    if (Object.keys(expected).length === 0) status = "unknown";
    else if (ok) status = "ok";
    else status = "error";

    return { status, errors, expected, actual };
}

//////////////////////////////////////////////////////////////
// RENDER SURVEILLANCE
//////////////////////////////////////////////////////////////
function updateDashboard() {
    let total = 0;
    lastPalettes.forEach(p => total += Number(p.total_qty));

    document.getElementById("stat-total").textContent = total;
    document.getElementById("stat-palettes").textContent = lastPalettes.length;

    const fill = Math.min(100, Math.round((total / 100) * 100));
    document.getElementById("stat-fill").textContent = fill + "%";
    document.getElementById("fill-progress").style.width = fill + "%";

    renderPalettesSurveillance();
}

function renderPalettesSurveillance() {
    const div = document.getElementById("palettes-container");
    div.innerHTML = "";

    lastPalettes.forEach(p => {
        const { status, errors, expected } = computeComplianceForPalette(p);

        const card = document.createElement("div");
        card.className = "card";

        let statusLabel = "Configuration manquante";
        let statusClass = "status-unknown";

        if (status === "ok") {
            statusLabel = "Palette conforme";
            statusClass = "status-ok";
        }
        if (status === "error") {
            statusLabel = "Palette non conforme";
            statusClass = "status-error";
        }

        let itemsHtml = "";
        p.items.forEach(it => {
            const exp = expected[it.name];
            itemsHtml += `
                <div>
                    <span>
                        <span class="name">${it.name}</span>
                        ${it.description ? `<span class="desc">${it.description}</span>` : ""}
                    </span>
                    <span>
                        <span class="qty">${it.qty}</span>
                        ${exp !== undefined ? `<span class="expect">(attendu : ${exp})</span>` : ""}
                    </span>
                </div>`;
        });

        card.innerHTML = `
            <h3>${p.name}</h3>
            <div class="palette-status ${statusClass}">${statusLabel}</div>
            <div class="items-list">${itemsHtml}</div>
            <div class="error-details">${errors.join("<br>")}</div>
        `;

        div.appendChild(card);
    });
}

//////////////////////////////////////////////////////////////
// RENDER CONFIG TAB
//////////////////////////////////////////////////////////////
function renderConfigTab() {
    const div = document.getElementById("config-container");
    div.innerHTML = "";

    lastPalettes.forEach(p => {
        const card = document.createElement("div");
        card.className = "config-card";

        const cfg = palettesConfig[p.name] || {};
        const lines = Object.keys(cfg).map(k => createConfigLineHtml(p.name, k, cfg[k])).join("");

        card.innerHTML = `
            <h4>${p.name}</h4>
            <div class="config-lines" data-palette="${p.name}">
                ${lines || createConfigLineHtml(p.name, "", "")}
            </div>
            <div class="config-actions">
                <button class="config-btn small" data-action="add-line" data-palette="${p.name}">+ Ajouter</button>
                <button class="config-btn small" data-action="fill-from-actual" data-palette="${p.name}">ü™Ñ Depuis r√©el</button>
            </div>
        `;

        div.appendChild(card);
    });

    attachConfigEvents();
}

function createConfigLineHtml(palette, name, qty) {
    return `
        <div class="config-line">
            <input type="text" class="cfg-name" value="${name}">
            <input type="number" class="cfg-qty" value="${qty}">
            <button class="config-btn small cfg-remove">‚úñ</button>
        </div>`;
}

function attachConfigEvents() {
    document.getElementById("config-container").addEventListener("click", e => {
        const btn = e.target.closest("button");
        if (!btn) return;

        const pName = btn.getAttribute("data-palette");
        const card = btn.closest(".config-card");
        const linesDiv = card.querySelector(".config-lines");

        if (btn.dataset.action === "add-line") {
            linesDiv.insertAdjacentHTML("beforeend", createConfigLineHtml(pName, "", ""));
        }

        if (btn.dataset.action === "fill-from-actual") {
            const palette = lastPalettes.find(p => p.name === pName);
            if (!palette) return;

            palettesConfig[pName] = {};
            linesDiv.innerHTML = "";

            palette.items.forEach(it => {
                palettesConfig[pName][it.name] = it.qty;
                linesDiv.insertAdjacentHTML("beforeend", createConfigLineHtml(pName, it.name, it.qty));
            });
        }

        if (btn.classList.contains("cfg-remove")) {
            btn.closest(".config-line").remove();
        }
    });
}

document.getElementById("btn-save-config").onclick = () => {
    palettesConfig = {};
    document.querySelectorAll(".config-card").forEach(card => {
        const pName = card.querySelector(".config-lines").dataset.palette;
        palettesConfig[pName] = {};

        card.querySelectorAll(".config-line").forEach(line => {
            const name = line.querySelector(".cfg-name").value.trim();
            const qty = Number(line.querySelector(".cfg-qty").value);
            if (name && qty > 0) palettesConfig[pName][name] = qty;
        });
    });

    saveConfig();
    renderPalettesSurveillance();
};

//////////////////////////////////////////////////////////////
// üî•üî•üî• R√âCUP√âRATION DES DONN√âES IA : /stats üî•üî•üî•
//////////////////////////////////////////////////////////////
async function updateIAStats() {
    try {
        const res = await fetch("http://192.168.100.182:5000/stats", { cache: "no-store" });
        const data = await res.json();

        // üü¢ Mise √† jour des champs IA
        document.getElementById("ia-cartons").textContent = data.cartons ?? "‚Äî";
        document.getElementById("ia-fps").textContent = data.fps ?? "‚Äî";
        document.getElementById("ia-framecount").textContent = data.frame_count ?? "‚Äî";
        document.getElementById("ia-motif").textContent = data.motif_used ?? "‚Äî";
        document.getElementById("ia-valid").textContent = data.motifs_valides ?? "‚Äî";

        const verdictEl = document.getElementById("ia-verdict");
        verdictEl.textContent = data.verdict ?? "‚Äî";

        // Code couleur du verdict
        if (data.verdict === "OK") verdictEl.style.color = "#4ade80";
        else if (data.verdict === "NOK") verdictEl.style.color = "#f87171";
        else verdictEl.style.color = "#e5e7eb";

    } catch (err) {
        console.error("Erreur /stats :", err);
    }
}

// üîÑ Mise √† jour IA toutes les 0.5 s
setInterval(updateIAStats, 500);
updateIAStats();

</script>
</body>
</html>

