<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Surveillance IoT ‚Äì Gestion de Stock</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Police -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1d35 100%);
            color: #e0e6ed;
            min-height: 100vh;
            padding: 20px;
        }

        .container { max-width: 1400px; margin: 0 auto; }

        /* Header */
        header {
            background: linear-gradient(135deg, #1e2742 0%, #2a3251 100%);
            padding: 20px 24px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
            margin-bottom: 20px;
            border: 1px solid rgba(96,165,250,0.2);
        }

        header h1 {
            font-size: 26px;
            font-weight: 700;
            color: #60a5fa;
            margin-bottom: 4px;
        }

        header p {
            color: #94a3b8;
            font-size: 13px;
            font-weight: 300;
        }

        /* Tabs */
        .tabs {
            margin-top: 16px;
            display: flex;
            gap: 10px;
        }

        .tab-btn {
            border-radius: 999px;
            padding: 8px 18px;
            font-size: 13px;
            border: 1px solid rgba(148,163,184,0.4);
            background: rgba(15,23,42,0.8);
            color: #cbd5f5;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .tab-btn.active {
            background: #2563eb;
            color: #e5e7eb;
            border-color: #60a5fa;
            box-shadow: 0 0 18px rgba(37,99,235,0.6);
        }

        .tab-btn:hover { transform: translateY(-1px); }

        .tab-content { margin-top: 20px; }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }

        /* Layout grid & cards */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .card {
            background: linear-gradient(135deg, #1e2742 0%, #252d47 100%);
            border-radius: 15px;
            padding: 18px 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.35);
            border: 1px solid rgba(96,165,250,0.15);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 40px rgba(96,165,250,0.25);
        }

        .card h3 {
            font-size: 17px;
            font-weight: 600;
            margin-bottom: 10px;
            color: #60a5fa;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 18px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #1e2742 0%, #252d47 100%);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            border: 1px solid rgba(96,165,250,0.15);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }

        .stat-label {
            font-size: 11px;
            text-transform: uppercase;
            color: #64748b;
            font-weight: 600;
            letter-spacing: 0.06em;
        }

        .stat-value {
            font-size: 30px;
            font-weight: 700;
            color: #60a5fa;
            margin-top: 6px;
        }

        .progress-bar {
            width: 100%; height: 8px;
            background: rgba(15,22,41,0.8);
            border-radius: 10px;
            margin-top: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #22c55e 0%, #10b981 100%);
            border-radius: 10px;
            width: 0%;
            transition: width 0.4s ease;
        }

        /* Camera */
        .camera-preview {
            width: 100%;
            height: 260px;
            background: #0f172a;
            border-radius: 12px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border: 2px solid rgba(96,165,250,0.25);
        }

        .camera-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .camera-preview .placeholder {
            color: #64748b;
            font-size: 14px;
            text-align: center;
        }

        /* Palettes & status */
        .palette-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 999px;
            margin-bottom: 8px;
        }

        .status-ok {
            background: rgba(22,163,74,0.2);
            color: #4ade80;
            border: 1px solid rgba(22,163,74,0.9);
        }

        .status-error {
            background: rgba(239,68,68,0.2);
            color: #fecaca;
            border: 1px solid rgba(239,68,68,0.9);
        }

        .status-unknown {
            background: rgba(148,163,184,0.2);
            color: #e5e7eb;
            border: 1px solid rgba(148,163,184,0.9);
        }

        .info-grid {
            margin-top: 8px;
            display: grid;
            grid-template-columns: repeat(2, minmax(0,1fr));
            gap: 10px;
        }

        .info-item {
            background: rgba(15,23,42,0.6);
            padding: 8px 10px;
            border-radius: 8px;
            border: 1px solid rgba(51,65,85,0.9);
        }

        .info-item label {
            display: block;
            font-size: 10px;
            text-transform: uppercase;
            color: #64748b;
            letter-spacing: 0.08em;
            margin-bottom: 4px;
        }

        .info-item .value {
            font-size: 15px;
            font-weight: 600;
            color: #e5e7eb;
        }

        .items-list {
            margin-top: 10px;
            font-size: 13px;
        }

        .items-list div {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            border-bottom: 1px dashed rgba(51,65,85,0.5);
        }

        .items-list div:last-child { border-bottom: none; }

        .items-list span.name { color: #e5e7eb; }
        .items-list span.qty { color: #93c5fd; font-weight: 600; }
        .items-list span.expect { font-size: 11px; color: #9ca3af; margin-left: 6px; }

        .error-details {
            margin-top: 8px;
            font-size: 11px;
            color: #fecaca;
        }

        /* Scan panel */
        .scan-input {
            width: 100%;
            padding: 8px 10px;
            border-radius: 999px;
            border: 1px solid rgba(148,163,184,0.6);
            background: rgba(15,23,42,0.9);
            color: #e5e7eb;
            font-size: 13px;
            outline: none;
        }

        .scan-input:focus {
            border-color: #60a5fa;
            box-shadow: 0 0 12px rgba(37,99,235,0.6);
        }

        .scan-select {
            width: 100%;
            margin-top: 8px;
            padding: 6px 10px;
            border-radius: 999px;
            border: 1px solid rgba(148,163,184,0.6);
            background: rgba(15,23,42,0.9);
            color: #e5e7eb;
            font-size: 13px;
        }

        .scan-status {
            margin-top: 10px;
            padding: 8px 10px;
            border-radius: 10px;
            font-size: 13px;
        }

        .scan-status-neutral {
            background: rgba(30,64,175,0.2);
            border: 1px solid rgba(59,130,246,0.7);
            color: #bfdbfe;
        }

        .scan-status-ok {
            background: rgba(22,163,74,0.2);
            border: 1px solid rgba(34,197,94,0.9);
            color: #bbf7d0;
        }

        .scan-status-bad {
            background: rgba(239,68,68,0.2);
            border: 1px solid rgba(239,68,68,0.9);
            color: #fecaca;
        }

        .scan-meta {
            margin-top: 6px;
            font-size: 11px;
            color: #9ca3af;
        }

        /* Config tab */
        .config-help {
            font-size: 13px;
            color: #9ca3af;
            margin-bottom: 12px;
        }

        .config-card {
            background: linear-gradient(135deg, #020617 0%, #111827 100%);
            border-radius: 14px;
            padding: 14px 16px;
            border: 1px solid rgba(75,85,99,0.7);
            box-shadow: 0 10px 30px rgba(15,23,42,0.9);
        }

        .config-card h4 {
            font-size: 15px;
            margin-bottom: 6px;
            color: #bfdbfe;
        }

        .config-line {
            display: flex;
            gap: 6px;
            margin-top: 6px;
        }

        .config-line input[type="text"] {
            flex: 2;
            padding: 5px 8px;
            border-radius: 6px;
            border: 1px solid rgba(148,163,184,0.7);
            background: rgba(15,23,42,0.9);
            color: #e5e7eb;
            font-size: 13px;
        }

        .config-line input[type="number"] {
            width: 70px;
            padding: 5px 6px;
            border-radius: 6px;
            border: 1px solid rgba(148,163,184,0.7);
            background: rgba(15,23,42,0.9);
            color: #e5e7eb;
            font-size: 13px;
        }

        .config-btn {
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 11px;
            border: 1px solid rgba(148,163,184,0.8);
            background: rgba(15,23,42,0.9);
            color: #e5e7eb;
            cursor: pointer;
        }

        .config-btn.small { padding: 3px 8px; font-size: 11px; }

        .config-actions {
            margin-top: 8px;
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .config-save-all {
            margin-top: 14px;
            padding: 6px 14px;
            border-radius: 999px;
            border: 1px solid #22c55e;
            background: rgba(22,163,74,0.15);
            color: #bbf7d0;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
        }

        .config-save-all:hover { background: rgba(22,163,74,0.25); }

        @media (max-width: 768px) {
            header h1 { font-size: 22px; }
            .stat-value { font-size: 24px; }
        }
    </style>
</head>
<body>
<div class="container">
    <header>
        <h1>üé• Surveillance IoT ‚Äì Gestion de Stock</h1>
        <p>Raspberry Pi ¬∑ WebSocket temps r√©el ¬∑ Inventree ¬∑ ESP32-CAM</p>

        <!-- Onglets -->
        <div class="tabs">
            <button class="tab-btn active" data-tab="surveillance">Surveillance</button>
            <button class="tab-btn" data-tab="config">Configuration palettes</button>
        </div>
    </header>

    <div class="tab-content">

        <!-- ===================== TAB SURVEILLANCE ===================== -->
        <section id="tab-surveillance" class="tab-panel active">

            <!-- Stats globales -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Colis total d√©tect√©s</div>
                    <div class="stat-value" id="stat-total">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Nombre de palettes</div>
                    <div class="stat-value" id="stat-palettes">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Taux de remplissage</div>
                    <div class="stat-value" id="stat-fill">0%</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="fill-progress"></div>
                    </div>
                </div>
            </div>

            <div class="dashboard-grid">
                <!-- Cam√©ra -->
                <div class="card">
                    <h3>Cam√©ra entrep√¥t</h3>
                    <div class="camera-preview">
                        <img id="camera-stream" src="http://192.168.100.139:81/stream" alt="Flux cam√©ra" style="display:none;">
                        <div class="placeholder" id="camera-placeholder">
                            Connexion au flux vid√©o‚Ä¶<br>
                            192.168.100.139
                        </div>
                    </div>
                </div>

                <!-- Dernier scan -->
                <div class="card">
                    <h3>Dernier scan (Inventree)</h3>
                    <input
                        id="scan-input"
                        class="scan-input"
                        type="text"
                        placeholder="Place ton curseur ici et scanne un QR / code-barres..."
                        autocomplete="off"
                    >
                    <select id="scan-palette-select" class="scan-select">
                        <option value="">Palette cible (s√©lectionne une palette)</option>
                    </select>

                    <div id="scan-status" class="scan-status scan-status-neutral">
                        En attente de scan‚Ä¶
                    </div>

                    <div id="scan-meta" class="scan-meta">
                        Aucun scan re√ßu pour le moment.
                    </div>
                </div>
            </div>

            <!-- Palettes -->
            <h3 style="margin: 10px 2px 8px;">Palettes & contenu (Inventree)</h3>
            <div class="dashboard-grid" id="palettes-container">
                <!-- Rempli dynamiquement -->
            </div>
        </section>

        <!-- ===================== TAB CONFIG ===================== -->
        <section id="tab-config" class="tab-panel">
            <p class="config-help">
                Ici tu d√©finis <strong>la r√©partition attendue</strong> des cartons par palette.<br>
                Le syst√®me v√©rifiera ensuite en temps r√©el et affichera ‚úî/‚ùå dans l‚Äôonglet <em>Surveillance</em>,
                et aussi pour chaque <strong>scan</strong>.
            </p>

            <div class="dashboard-grid" id="config-container">
                <!-- Rempli dynamiquement -->
            </div>

            <button class="config-save-all" id="btn-save-config">
                üíæ Enregistrer la configuration (localStorage navigateur)
            </button>
        </section>
    </div>
</div>

<script>
    // =============================
    // Gestion des onglets
    // =============================
    const tabButtons = document.querySelectorAll('.tab-btn');
    const tabPanels = document.querySelectorAll('.tab-panel');

    tabButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            const target = btn.getAttribute('data-tab');

            tabButtons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            tabPanels.forEach(p => {
                if (p.id === 'tab-' + target) p.classList.add('active');
                else p.classList.remove('active');
            });
        });
    });

    // =============================
    // Gestion cam√©ra
    // =============================
    const camImg = document.getElementById('camera-stream');
    const camPlaceholder = document.getElementById('camera-placeholder');

    camImg.onload = () => {
        camImg.style.display = 'block';
        camPlaceholder.style.display = 'none';
    };

    camImg.onerror = () => {
        camImg.style.display = 'none';
        camPlaceholder.style.display = 'block';
        camPlaceholder.innerHTML = "Flux vid√©o indisponible<br>192.168.100.139";
    };

    setInterval(() => {
        camImg.src = "http://192.168.100.139:81/stream?ts=" + Date.now();
    }, 20000);

    // =============================
    // WebSocket + Inventree
    // =============================
    const ws = new WebSocket("ws://192.168.100.112:8765"); // adapte l‚ÄôIP si besoin

    let lastPalettes = [];
    let palettesConfig = {}; // { "PALETTE 1": { "CARTON A": 2, ... }, ... }

    let lastScan = null;           // objet renvoy√© par le serveur
    let selectedPaletteName = "";  // palette cible pour le scan

    // Charger configuration depuis localStorage
    function loadConfig() {
        try {
            const raw = localStorage.getItem('palettesConfig');
            palettesConfig = raw ? JSON.parse(raw) : {};
        } catch (e) {
            console.error("Erreur parse palettesConfig:", e);
            palettesConfig = {};
        }
    }

    function saveConfig() {
        localStorage.setItem('palettesConfig', JSON.stringify(palettesConfig));
        alert("Configuration palettes sauvegard√©e (localStorage navigateur).");
    }

    loadConfig();

    ws.onopen = () => {
        console.log("WebSocket connect√©");
    };

    ws.onerror = (err) => {
        console.error("Erreur WebSocket :", err);
    };

    ws.onclose = () => {
        console.warn("WebSocket ferm√©");
    };

    ws.onmessage = (event) => {
        const msg = JSON.parse(event.data);

        if (msg.inventree && msg.inventree.palettes) {
            lastPalettes = msg.inventree.palettes;
            updateDashboard();
        }

        if (msg.scan) {
            lastScan = msg.scan;
            updateScanPanel();
        }
    };

    // =============================
    // Comparaison config vs r√©el
    // =============================
    function computeComplianceForPalette(palette) {
        const name = palette.name || "Palette inconnue";
        const expected = palettesConfig[name] || {};
        const actual = {};

        (palette.items || []).forEach(it => {
            const n = it.name || "Sans nom";
            const q = Number(it.qty || it.quantity || 0);
            actual[n] = (actual[n] || 0) + q;
        });

        const errors = [];
        let ok = true;

        Object.keys(expected).forEach(cartonName => {
            const expQty = Number(expected[cartonName]);
            const actQty = Number(actual[cartonName] || 0);

            if (actQty < expQty) {
                ok = false;
                errors.push(`Manque ${expQty - actQty} √ó ${cartonName}`);
            } else if (actQty > expQty) {
                ok = false;
                errors.push(`${actQty - expQty} √ó ${cartonName} en trop`);
            }
        });

        Object.keys(actual).forEach(cartonName => {
            if (!(cartonName in expected)) {
                ok = false;
                errors.push(`Carton non pr√©vu : ${cartonName} (x${actual[cartonName]})`);
            }
        });

        let status = "unknown";
        if (Object.keys(expected).length === 0) status = "unknown";
        else if (ok) status = "ok";
        else status = "error";

        return { status, errors, expected, actual };
    }

    // =============================
    // Mise √† jour dashboard
    // =============================
    function updateDashboard() {
        let totalColis = 0;
        lastPalettes.forEach(p => totalColis += Number(p.total_qty || 0));

        document.getElementById('stat-total').innerText = totalColis;
        document.getElementById('stat-palettes').innerText = lastPalettes.length;

        const fillRate = Math.min(100, Math.round((totalColis / 100) * 100));
        document.getElementById('stat-fill').innerText = fillRate + "%";
        document.getElementById('fill-progress').style.width = fillRate + "%";

        renderPalettesSurveillance();
        renderConfigTab();
        updatePaletteSelectOptions();
    }

    // =============================
    // Rendu pallettes (Surveillance)
    // =============================
    function renderPalettesSurveillance() {
        const container = document.getElementById('palettes-container');
        container.innerHTML = "";

        lastPalettes.forEach(palette => {
            const { status, errors, expected } = computeComplianceForPalette(palette);
            const pName = palette.name || "Palette inconnue";

            let statusClass = "status-unknown";
            let statusText = "Configuration manquante";

            if (status === "ok") {
                statusClass = "status-ok";
                statusText = "Palette conforme";
            } else if (status === "error") {
                statusClass = "status-error";
                statusText = "Palette non conforme";
            }

            let itemsHtml = "";
            (palette.items || []).forEach(item => {
                const n = item.name || "Sans nom";
                const q = Number(item.qty || item.quantity || 0);
                const exp = expected[n] !== undefined ? expected[n] : null;

                itemsHtml += `
                    <div>
                        <span class="name">${n}</span>
                        <span>
                            <span class="qty">${q}</span>
                            ${exp !== null ? `<span class="expect">(attendu : ${exp})</span>` : ""}
                        </span>
                    </div>
                `;
            });

            let errorHtml = "";
            if (errors.length > 0) {
                errorHtml = `<div class="error-details">${errors.join("<br>")}</div>`;
            }

            const card = document.createElement('div');
            card.className = "card";
            card.innerHTML = `
                <h3>${pName}</h3>
                <div class="palette-status ${statusClass}">
                    ${status === "ok" ? "‚úî" : (status === "error" ? "‚úñ" : "?")} ${statusText}
                </div>
                <div class="info-grid">
                    <div class="info-item">
                        <label>Colis</label>
                        <div class="value">${palette.total_qty || 0}</div>
                    </div>
                    <div class="info-item">
                        <label>Articles uniques</label>
                        <div class="value">${(palette.items || []).length}</div>
                    </div>
                </div>
                <div class="items-list">
                    ${itemsHtml || "<div><span class='name'>Aucun article</span></div>"}
                </div>
                ${errorHtml}
            `;

            container.appendChild(card);
        });
    }

    // =============================
    // Rendu configuration palettes
    // =============================
    function renderConfigTab() {
        const container = document.getElementById('config-container');
        container.innerHTML = "";

        lastPalettes.forEach(palette => {
            const pName = palette.name || "Palette inconnue";
            if (!palettesConfig[pName]) palettesConfig[pName] = {};

            const card = document.createElement('div');
            card.className = "config-card";

            let linesHtml = "";
            const currentConfig = palettesConfig[pName];
            const cartonNames = Object.keys(currentConfig);

            if (cartonNames.length === 0) {
                linesHtml += createConfigLineHtml(pName, "", "");
            } else {
                cartonNames.forEach(cartonName => {
                    const qty = currentConfig[cartonName];
                    linesHtml += createConfigLineHtml(pName, cartonName, qty);
                });
            }

            card.innerHTML = `
                <h4>${pName}</h4>
                <div style="font-size:12px; color:#9ca3af; margin-bottom:6px;">
                    D√©finis ici les cartons attendus sur cette palette.
                </div>
                <div class="config-lines" data-palette="${pName}">
                    ${linesHtml}
                </div>
                <div class="config-actions">
                    <button class="config-btn small" data-action="add-line" data-palette="${pName}">+ Ajouter un carton</button>
                    <button class="config-btn small" data-action="fill-from-actual" data-palette="${pName}">ü™Ñ Prendre l'√©tat actuel comme r√©f√©rence</button>
                </div>
            `;

            container.appendChild(card);
        });

        attachConfigEvents();
    }

    function createConfigLineHtml(paletteName, cartonName, qty) {
        const safeName = cartonName || "";
        const safeQty = qty !== undefined && qty !== null && qty !== "" ? qty : "";
        return `
            <div class="config-line" data-palette="${paletteName}">
                <input type="text" class="cfg-name" placeholder="Nom du carton (ex: CARTON A)" value="${safeName}">
                <input type="number" class="cfg-qty" placeholder="Qt√©" min="0" value="${safeQty}">
                <button class="config-btn small cfg-remove">‚úñ</button>
            </div>
        `;
    }

    function attachConfigEvents() {
        const configContainer = document.getElementById('config-container');

        configContainer.addEventListener('click', (e) => {
            const btn = e.target.closest('button');
            if (!btn) return;

            const action = btn.getAttribute('data-action');
            const paletteName = btn.getAttribute('data-palette');

            if (action === 'add-line') {
                const linesDiv = btn.closest('.config-card').querySelector('.config-lines');
                linesDiv.insertAdjacentHTML('beforeend', createConfigLineHtml(paletteName, "", ""));
            }

            if (action === 'fill-from-actual') {
                const palette = lastPalettes.find(p => p.name === paletteName);
                if (!palette) return;

                const linesDiv = btn.closest('.config-card').querySelector('.config-lines');
                linesDiv.innerHTML = "";

                const actual = {};
                (palette.items || []).forEach(it => {
                    const n = it.name || "Sans nom";
                    const q = Number(it.qty || it.quantity || 0);
                    actual[n] = (actual[n] || 0) + q;
                });

                palettesConfig[paletteName] = {};
                Object.keys(actual).forEach(n => {
                    const q = actual[n];
                    palettesConfig[paletteName][n] = q;
                    linesDiv.insertAdjacentHTML('beforeend', createConfigLineHtml(paletteName, n, q));
                });
            }

            if (btn.classList.contains('cfg-remove')) {
                const line = btn.closest('.config-line');
                if (line) line.remove();
            }
        });
    }

    document.getElementById('btn-save-config').addEventListener('click', () => {
        const configContainer = document.getElementById('config-container');
        palettesConfig = {};

        const allCards = configContainer.querySelectorAll('.config-card');
        allCards.forEach(card => {
            const linesDiv = card.querySelector('.config-lines');
            const paletteName = linesDiv.getAttribute('data-palette');
            const lines = card.querySelectorAll('.config-line');

            palettesConfig[paletteName] = {};

            lines.forEach(line => {
                const nameInput = line.querySelector('.cfg-name');
                const qtyInput = line.querySelector('.cfg-qty');
                const cartonName = (nameInput.value || "").trim();
                const qty = Number(qtyInput.value || 0);

                if (cartonName && qty > 0) {
                    palettesConfig[paletteName][cartonName] = qty;
                }
            });
        });

        saveConfig();
        renderPalettesSurveillance();
    });

    // =============================
    // Palette select pour scan
    // =============================
    function updatePaletteSelectOptions() {
        const select = document.getElementById('scan-palette-select');
        const previous = select.value;

        select.innerHTML = '<option value="">Palette cible (s√©lectionne une palette)</option>';

        lastPalettes.forEach(p => {
            const name = p.name || "Palette inconnue";
            const opt = document.createElement('option');
            opt.value = name;
            opt.textContent = name;
            select.appendChild(opt);
        });

        if (previous && [...select.options].some(o => o.value === previous)) {
            select.value = previous;
            selectedPaletteName = previous;
        }
    }

    document.getElementById('scan-palette-select').addEventListener('change', (e) => {
        selectedPaletteName = e.target.value;
        updateScanPanel(); // pour recalculer conforme / pas conforme si on a d√©j√† un scan
    });

    // =============================
    // Gestion du scan (input texte)
    // =============================
    const scanInput = document.getElementById('scan-input');
    const scanStatusDiv = document.getElementById('scan-status');
    const scanMetaDiv = document.getElementById('scan-meta');

    // On essaie de focus l'input d√®s le chargement
    window.addEventListener('load', () => {
        scanInput.focus();
    });

    scanInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            const barcode = scanInput.value.trim();
            if (!barcode) return;

            if (ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: "scan", barcode: barcode }));
                scanStatusDiv.className = "scan-status scan-status-neutral";
                scanStatusDiv.textContent = "Scan envoy√©‚Ä¶ en attente de r√©ponse Inventree.";
            } else {
                scanStatusDiv.className = "scan-status scan-status-bad";
                scanStatusDiv.textContent = "WebSocket non connect√©.";
            }

            // On vide l'input pour le prochain scan
            scanInput.value = "";
        }
    });

    function updateScanPanel() {
        if (!lastScan) {
            scanStatusDiv.className = "scan-status scan-status-neutral";
            scanStatusDiv.textContent = "En attente de scan‚Ä¶";
            scanMetaDiv.textContent = "Aucun scan re√ßu pour le moment.";
            return;
        }

        const ok = lastScan.ok;
        const name = lastScan.name || "(nom inconnu)";
        const location = lastScan.location || "(emplacement inconnu)";
        const barcode = lastScan.barcode || "(code inconnu)";
        const description = lastScan.description || "";

        if (!selectedPaletteName) {
            scanStatusDiv.className = "scan-status scan-status-neutral";
            scanStatusDiv.textContent = "Scan re√ßu, mais aucune palette cible s√©lectionn√©e.";
        } else {
            const expectedMap = palettesConfig[selectedPaletteName] || {};
            const isExpected = !!expectedMap[name];

            if (!ok) {
                scanStatusDiv.className = "scan-status scan-status-bad";
                scanStatusDiv.textContent = "Erreur Inventree : " + (lastScan.error || "inconnue");
            } else if (Object.keys(expectedMap).length === 0) {
                scanStatusDiv.className = "scan-status scan-status-neutral";
                scanStatusDiv.textContent = `Scan : ${name} ‚Äî aucune configuration d√©finie pour ${selectedPaletteName}.`;
            } else if (isExpected) {
                scanStatusDiv.className = "scan-status scan-status-ok";
                scanStatusDiv.textContent = `‚úî ${name} est attendu sur ${selectedPaletteName}.`;
            } else {
                scanStatusDiv.className = "scan-status scan-status-bad";
                scanStatusDiv.textContent = `‚úñ ${name} ne fait pas partie des cartons attendus sur ${selectedPaletteName}.`;
            }
        }

        let meta = `Code scann√© : ${barcode}`;
        meta += ` | Article : ${name}`;
        if (description) meta += ` | ${description}`;
        meta += ` | Emplacement Inventree : ${location}`;
        scanMetaDiv.textContent = meta;
    }
</script>
</body>
</html>
