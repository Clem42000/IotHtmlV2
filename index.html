<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Surveillance IoT ‚Äì Gestion de Stock</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Police -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
/* ===== RESET ===== */
* { margin:0; padding:0; box-sizing:border-box; }

body {
    font-family:'Poppins',sans-serif;
    background:linear-gradient(135deg,#0a0e27,#1a1d35);
    color:#e0e6ed;
    min-height:100vh;
    padding:20px;
}

.container { max-width:1400px; margin:0 auto; }

/* ===== HEADER ===== */
header {
    background:linear-gradient(135deg,#1e2742,#2a3251);
    padding:20px 24px;
    border-radius:15px;
    box-shadow:0 8px 32px rgba(0,0,0,0.4);
    margin-bottom:20px;
    border:1px solid rgba(96,165,250,0.2);
}
header h1 { font-size:26px; font-weight:700; color:#60a5fa; margin-bottom:4px; }
header p { font-size:13px; color:#94a3b8; }

/* ===== TABS ===== */
.tabs { margin-top:16px; display:flex; gap:10px; }
.tab-btn {
    padding:8px 18px; font-size:13px;
    border-radius:999px;
    border:1px solid rgba(148,163,184,0.4);
    background:rgba(15,23,42,0.8);
    color:#cbd5f5; cursor:pointer;
    transition:.2s;
}
.tab-btn.active {
    background:#2563eb; color:white;
    border-color:#60a5fa;
    box-shadow:0 0 18px rgba(37,99,235,0.6);
}
.tab-panel { display:none; }
.tab-panel.active { display:block; }

/* ===== GRID ===== */
.dashboard-grid {
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(320px,1fr));
    gap:20px;
    margin-bottom:25px;
}

/* ===== CARDS ===== */
.card {
    background:linear-gradient(135deg,#1e2742,#252d47);
    padding:18px 20px;
    border-radius:15px;
    border:1px solid rgba(96,165,250,0.15);
    box-shadow:0 8px 32px rgba(0,0,0,0.35);
}
.card h3 {
    font-size:17px; font-weight:600;
    color:#60a5fa; margin-bottom:8px;
}

/* ===== CAMERA ===== */
.camera-preview {
    width:100%; height:260px;
    background:#0f172a;
    border-radius:12px;
    border:2px solid rgba(96,165,250,.25);
    display:flex; align-items:center; justify-content:center;
    overflow:hidden;
    margin-bottom:10px;
}
.camera-preview img {
    width:100%; height:100%;
    object-fit:contain;
}
.placeholder {
    color:#64748b;
    font-size:14px;
    text-align:center;
}

/* ===== CAM METRICS ===== */
.cam-metrics {
    margin-top:10px; padding:10px;
    border-radius:10px;
    background:rgba(15,23,42,.9);
    border:1px solid rgba(96,165,250,.25);
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(140px,1fr));
    gap:10px;
}
.cam-metric-label {
    font-size:10px;
    color:#64748b;
    text-transform:uppercase;
    letter-spacing:.08em;
}
.cam-metric-value { font-weight:600; }

/* ===== LIVE IA STATS ===== */
.live-stats-grid {
    margin-top:12px;
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
    gap:14px;
}
.live-stat-card {
    background:rgba(15,23,42,0.6);
    padding:14px;
    border-radius:12px;
    border:1px solid rgba(51,65,85,0.8);
    text-align:center;
    box-shadow:0 6px 20px rgba(0,0,0,0.25);
}
.live-stat-label { font-size:12px; color:#94a3b8; }
.live-stat-value { font-size:28px; font-weight:700; color:#e5e7eb; }

/* Legend */
.live-legend { margin-top:18px; font-size:14px; }
.legend-line { display:flex; align-items:center; gap:6px; margin-top:6px; }
.legend-box {
    width:16px; height:16px; border-radius:4px;
}
.legend-box.green { background:#22c55e; }
.legend-box.red   { background:#ef4444; }

/* ===== PALLETES ===== */
.items-list div {
    display:flex; justify-content:space-between;
    padding:4px 0;
    border-bottom:1px dashed rgba(51,65,85,0.5);
}
.items-list span.name { font-weight:600; }
.items-list span.desc { font-size:11px; color:#9ca3af; }
.items-list span.qty  { color:#93c5fd; font-weight:600; }
.items-list span.expect { font-size:11px; color:#9ca3af; margin-left:6px; }

/* Status badge */
.palette-status {
    display:inline-flex; align-items:center;
    gap:6px; padding:4px 10px;
    font-size:12px; border-radius:999px;
    margin-bottom:8px;
}
.status-ok      { background:rgba(22,163,74,.2);  color:#4ade80; border:1px solid #16a34a; }
.status-error   { background:rgba(239,68,68,.2); color:#fecaca; border:1px solid #ef4444; }
.status-unknown { background:rgba(148,163,184,.2); color:#e5e7eb; border:1px solid #94a3b8; }

.error-details { margin-top:8px; font-size:11px; color:#fecaca; }

/* CONFIG */
.config-card {
    background:linear-gradient(135deg,#020617,#111827);
    padding:14px 16px;
    border-radius:14px;
    border:1px solid rgba(75,85,99,0.7);
}
.config-line { display:flex; gap:6px; margin-top:6px; }
.config-line input {
    background:#0f172a; color:white;
    border-radius:6px; border:1px solid rgba(148,163,184,0.7);
    padding:5px 8px;
}
</style>
</head>
<body>
<div class="container">

<header>
    <h1>üé• Surveillance IoT ‚Äì Gestion de Stock</h1>
    <p>Raspberry Pi ¬∑ WebSocket temps r√©el ¬∑ InvenTree ¬∑ ESP32-CAM ¬∑ IA embarqu√©e</p>

    <div class="tabs">
        <button class="tab-btn active" data-tab="surveillance">Surveillance</button>
        <button class="tab-btn" data-tab="config">Configuration palettes</button>
    </div>
</header>
    <div class="tab-content">

<!-- ========================================================= -->
<!-- ===================== TAB SURVEILLANCE ================== -->
<!-- ========================================================= -->
<section id="tab-surveillance" class="tab-panel active">

    <!-- ====== STATISTIQUES GLOBALES ====== -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-label">Colis total d√©tect√©s</div>
            <div class="stat-value" id="stat-total">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Nombre de palettes</div>
            <div class="stat-value" id="stat-palettes">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Taux de remplissage</div>
            <div class="stat-value" id="stat-fill">0%</div>
            <div class="progress-bar">
                <div class="progress-fill" id="fill-progress"></div>
            </div>
        </div>
    </div>

    <!-- ====== CAMERA + STATUT SYSTEME ====== -->
    <div class="dashboard-grid dashboard-main">

        <!-- ====== CAMERA ====== -->
        <div class="card camera-card">
            <h3>Cam√©ra entrep√¥t</h3>

            <div class="camera-preview">
                <img id="camera-stream"
                     src="http://192.168.100.182:5000/video_feed"
                     alt="Flux cam√©ra"
                     style="display:none;">
                <div class="placeholder" id="camera-placeholder">
                    Connexion au flux vid√©o‚Ä¶<br>
                    http://192.168.100.182:5000/video_feed
                </div>
            </div>

            <div id="camera-status"
                 style="margin-top:8px; font-size:13px; color:#9ca3af;">
                 Statut cam√©ra : <span id="camera-status-value">‚è≥ V√©rification‚Ä¶</span>
            </div>

            <!-- ====== METRIQUES CAMERA / WS ====== -->
            <div class="cam-metrics">
                <div><span class="cam-metric-label">WebSocket</span>
                     <span class="cam-metric-value" id="ws-status">‚è≥ Connexion‚Ä¶</span>
                </div>
                <div><span class="cam-metric-label">Dernier message WS</span>
                     <span class="cam-metric-value" id="ws-last-msg">‚Äî</span>
                </div>
                <div><span class="cam-metric-label">Derni√®re maj palettes</span>
                     <span class="cam-metric-value" id="ws-last-palettes">‚Äî</span>
                </div>
                <div><span class="cam-metric-label">Flux vid√©o</span>
                     <span class="cam-metric-value" id="cam-stream-status">En cours‚Ä¶</span>
                </div>
            </div>
        </div>

        <!-- ====== STATUT SYSTEME + IA ====== -->
        <div class="card">
            <h3>Statut & sp√©cifications syst√®me</h3>

            <!-- ====== STATISTIQUES IA EN DIRECT ====== -->
            <h3 style="margin-top:18px; margin-bottom:10px; color:#93c5fd;">
                üì¶ Analyse IA en direct (ESP32-CAM)
            </h3>

            <div class="live-stats-grid">

                <div class="live-stat-card">
                    <div class="live-stat-label">Cartons d√©tect√©s</div>
                    <div class="live-stat-value" id="st-detected">‚Äî</div>
                </div>

                <div class="live-stat-card">
                    <div class="live-stat-label">FPS Analyse</div>
                    <div class="live-stat-value" id="st-fps">‚Äî</div>
                </div>

                <div class="live-stat-card">
                    <div class="live-stat-label">Images trait√©es</div>
                    <div class="live-stat-value" id="st-frame">‚Äî</div>
                </div>

                <div class="live-stat-card">
                    <div class="live-stat-label">Motif utilis√©</div>
                    <div class="live-stat-value" id="st-motif">‚Äî</div>
                </div>

                <div class="live-stat-card">
                    <div class="live-stat-label">Motifs valides</div>
                    <div class="live-stat-value" id="st-valid">‚Äî</div>
                </div>

                <div class="live-stat-card">
                    <div class="live-stat-label">Verdict IA</div>
                    <div class="live-stat-value" id="st-verdict">‚Äî</div>
                </div>

            </div>

            <div class="live-legend">
                <h4>L√©gende :</h4>
                <div class="legend-line">
                    <span class="legend-box green"></span> Motif valide (zone correcte)
                </div>
                <div class="legend-line">
                    <span class="legend-box red"></span> Motif invalide (hors zone)
                </div>
            </div>

            <div class="specs-grid" style="margin-top:18px;">
                <div class="info-item"><label>Latence WebSocket typique</label><div class="value">‚âà 18 ms</div></div>
                <div class="info-item"><label>Cycle de mise √† jour stock</label><div class="value">2 s</div></div>
                <div class="info-item"><label>Latence API InvenTree</label><div class="value">&lt; 80 ms</div></div>
                <div class="info-item"><label>Disponibilit√© cible</label><div class="value">99,95 %</div></div>
                <div class="info-item"><label>Plateforme</label><div class="value">Raspberry Pi ¬∑ Python ¬∑ WebSockets</div></div>
                <div class="info-item"><label>Flux cam√©ra</label><div class="value">ESP32-CAM ¬∑ 720p</div></div>
            </div>

        </div>
    </div>

    <!-- ====== PALETTES INVENTREE ====== -->
    <h3 style="margin: 10px 2px 8px;">Palettes & contenu (InvenTree)</h3>
    <div class="dashboard-grid" id="palettes-container"></div>

</section>

<!-- ========================================================= -->
<!-- ===================== TAB CONFIGURATION ================= -->
<!-- ========================================================= -->
<section id="tab-config" class="tab-panel">
    <p style="color:#9ca3af; font-size:13px; margin-bottom:12px;">
        Configure ici les cartons attendus pour chaque palette.
    </p>

    <div class="dashboard-grid" id="config-container"></div>

    <button class="config-save-all" id="btn-save-config">
        üíæ Enregistrer la configuration
    </button>
</section>

</div><!-- /tab-content -->
</div><!-- /container -->
<script>
// =========================================================
// üîß CONFIG
// =========================================================
const WS_URL = "ws://192.168.100.112:8765";
const STATS_URL = "http://192.168.100.182:5000/stats";   // CORRECT
const VIDEO_URL = "http://192.168.100.182:5000/video_feed";

let lastPalettes = [];
let palettesConfig = {};
let lastWsMessageTime = null;

// =========================================================
// üîÑ ONGLET
// =========================================================
document.querySelectorAll(".tab-btn").forEach(btn => {
    btn.addEventListener("click", () => {
        const tab = btn.getAttribute("data-tab");

        document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");

        document.querySelectorAll(".tab-panel").forEach(p => p.classList.remove("active"));
        document.getElementById("tab-" + tab).classList.add("active");

        if (tab === "config") renderConfigTab();
    });
});

// =========================================================
// üì∑ GESTION CAMERA
// =========================================================
const camImg = document.getElementById("camera-stream");
const camPlaceholder = document.getElementById("camera-placeholder");

camImg.onload = () => {
    camImg.style.display = "block";
    camPlaceholder.style.display = "none";
    document.getElementById("cam-stream-status").textContent = "Flux actif";
};
camImg.onerror = () => {
    camImg.style.display = "none";
    camPlaceholder.style.display = "block";
    camPlaceholder.innerHTML = "Flux indisponible<br>" + VIDEO_URL;
    document.getElementById("cam-stream-status").textContent = "Erreur flux";
};

// Anti-freeze toutes les 20 s
setInterval(() => {
    camImg.src = VIDEO_URL + "?ts=" + Date.now();
}, 20000);

// =========================================================
// üîå WEBSOCKET INVENTREE
// =========================================================
const ws = new WebSocket(WS_URL);

ws.onopen = () => setWsStatus("üü¢ Connect√©", "#4ade80");
ws.onerror = () => setWsStatus("üî¥ Erreur", "#ef4444");
ws.onclose = () => setWsStatus("üî¥ D√©connect√©", "#ef4444");

ws.onmessage = (event) => {
    lastWsMessageTime = new Date();
    updateWsLastMessage();

    const msg = JSON.parse(event.data);
    
    if (!msg.inventree || !msg.inventree.palettes) return;

    lastPalettes = msg.inventree.palettes;
    document.getElementById("ws-last-palettes").textContent = new Date().toLocaleTimeString();

    updateDashboard();
};

function setWsStatus(text, color) {
    const el = document.getElementById("ws-status");
    el.textContent = text;
    el.style.color = color;
}

function updateWsLastMessage() {
    const el = document.getElementById("ws-last-msg");
    el.textContent = lastWsMessageTime ? lastWsMessageTime.toLocaleTimeString() : "‚Äî";
}

// =========================================================
// üíæ CONFIG LOCALSTORAGE
// =========================================================
function loadConfig() {
    palettesConfig = JSON.parse(localStorage.getItem("palettesConfig") || "{}");
}
loadConfig();

function saveConfig() {
    localStorage.setItem("palettesConfig", JSON.stringify(palettesConfig));
    alert("Configuration enregistr√©e !");
}

// =========================================================
// üîç COMPARAISON CONFIG VS REEL
// =========================================================
function computeComplianceForPalette(p) {
    const expected = palettesConfig[p.name] || {};
    const actual = {};

    (p.items || []).forEach(it => {
        actual[it.name] = (actual[it.name] || 0) + Number(it.qty || it.quantity || 0);
    });

    const errors = [];
    let ok = true;

    // Manques / trop
    Object.keys(expected).forEach(name => {
        const exp = expected[name];
        const act = actual[name] || 0;

        if (act < exp) { ok = false; errors.push(`Manque ${exp - act} √ó ${name}`); }
        if (act > exp) { ok = false; errors.push(`${act - exp} √ó ${name} en trop`); }
    });

    // Cartons non pr√©vus
    Object.keys(actual).forEach(name => {
        if (!(name in expected)) {
            ok = false;
            errors.push(`Carton non pr√©vu : ${name} (x${actual[name]})`);
        }
    });

    return {
        status: Object.keys(expected).length === 0 ? "unknown" : (ok ? "ok" : "error"),
        errors,
        expected
    };
}

// =========================================================
// üìä MISE √Ä JOUR DASHBOARD
// =========================================================
function updateDashboard() {
    let total = lastPalettes.reduce((s, p) => s + (Number(p.total_qty) || 0), 0);

    document.getElementById("stat-total").textContent = total;
    document.getElementById("stat-palettes").textContent = lastPalettes.length;

    const fill = Math.min(100, Math.round((total / 100) * 100));
    document.getElementById("stat-fill").textContent = fill + "%";
    document.getElementById("fill-progress").style.width = fill + "%";

    renderPalettesSurveillance();
}

// =========================================================
// üü¶ AFFICHAGE DES PALETTES
// =========================================================
function renderPalettesSurveillance() {
    const container = document.getElementById("palettes-container");
    container.innerHTML = "";

    lastPalettes.forEach(p => {
        const { status, errors, expected } = computeComplianceForPalette(p);

        let classStatus = "status-unknown";
        let textStatus = "Configuration manquante";

        if (status === "ok") { classStatus = "status-ok"; textStatus = "Palette conforme"; }
        if (status === "error") { classStatus = "status-error"; textStatus = "Palette non conforme"; }

        const card = document.createElement("div");
        card.className = "card";

        let items = "";
        (p.items || []).forEach(it => {
            items += `
            <div>
                <span><span class="name">${it.name}</span></span>
                <span>
                    <span class="qty">${it.qty}</span>
                    ${expected[it.name] !== undefined ? `<span class="expect">(attendu : ${expected[it.name]})</span>` : ""}
                </span>
            </div>`;
        });

        card.innerHTML = `
            <h3>${p.name}</h3>
            <div class="palette-status ${classStatus}">${textStatus}</div>

            <div class="info-grid">
                <div class="info-item"><label>Colis</label><div class="value">${p.total_qty}</div></div>
                <div class="info-item"><label>Articles</label><div class="value">${p.items.length}</div></div>
            </div>

            <div class="items-list">${items}</div>

            <div class="error-details">${errors.join("<br>")}</div>
        `;

        container.appendChild(card);
    });
}

// =========================================================
// üîß RENDER CONFIG
// =========================================================
function renderConfigTab() {
    const div = document.getElementById("config-container");
    div.innerHTML = "";

    lastPalettes.forEach(p => {
        const cfg = palettesConfig[p.name] || {};
        
        const card = document.createElement("div");
        card.className = "config-card";

        let lines = Object.keys(cfg).map(name => createConfigLineHtml(p.name, name, cfg[name])).join("");

        if (lines === "") lines = createConfigLineHtml(p.name, "", "");

        card.innerHTML = `
            <h4>${p.name}</h4>
            <div class="config-lines" data-palette="${p.name}">
                ${lines}
            </div>
            <div class="config-actions">
                <button class="config-btn small" data-action="add-line" data-palette="${p.name}">+ Ajouter</button>
                <button class="config-btn small" data-action="fill-from-actual" data-palette="${p.name}">ü™Ñ Depuis r√©el</button>
            </div>
        `;

        div.appendChild(card);
    });

    attachConfigEvents();
}

function createConfigLineHtml(pName, name, qty) {
    return `
    <div class="config-line">
        <input type="text" class="cfg-name" value="${name}">
        <input type="number" class="cfg-qty" min="0" value="${qty}">
        <button class="config-btn small cfg-remove">‚úñ</button>
    </div>`;
}

function attachConfigEvents() {
    document.getElementById("config-container").addEventListener("click", e => {
        const btn = e.target.closest("button");
        if (!btn) return;

        const pName = btn.dataset.palette;
        const card = btn.closest(".config-card");
        const linesDiv = card.querySelector(".config-lines");

        if (btn.dataset.action === "add-line") {
            linesDiv.insertAdjacentHTML("beforeend", createConfigLineHtml(pName, "", ""));
        }

        if (btn.dataset.action === "fill-from-actual") {
            const palette = lastPalettes.find(p => p.name === pName);
            if (!palette) return;

            palettesConfig[pName] = {};
            linesDiv.innerHTML = "";

            palette.items.forEach(it => {
                palettesConfig[pName][it.name] = it.qty;
                linesDiv.insertAdjacentHTML("beforeend", createConfigLineHtml(pName, it.name, it.qty));
            });
        }

        if (btn.classList.contains("cfg-remove")) {
            btn.closest(".config-line").remove();
        }
    });
}

document.getElementById("btn-save-config").onclick = () => {
    palettesConfig = {};

    document.querySelectorAll(".config-card").forEach(card => {
        const pName = card.querySelector(".config-lines").dataset.palette;
        palettesConfig[pName] = {};

        card.querySelectorAll(".config-line").forEach(line => {
            const name = line.querySelector(".cfg-name").value.trim();
            const qty = Number(line.querySelector(".cfg-qty").value);
            if (name && qty > 0) palettesConfig[pName][name] = qty;
        });
    });

    saveConfig();
    renderPalettesSurveillance();
};

// =========================================================
// üî•üî•üî• R√âCUP√âRATION IA : /stats üî•üî•üî•
// =========================================================
async function updateAIStats() {
    try {
        const res = await fetch(STATS_URL, { cache: "no-store" });
        const d = await res.json();

        // üî• MAP EXACTE SELON TES DONN√âES
        document.getElementById("st-detected").textContent = d.cartons ?? "‚Äî";
        document.getElementById("st-fps").textContent = d.fps ?? "‚Äî";
        document.getElementById("st-frame").textContent = d.frame_count ?? "‚Äî";
        document.getElementById("st-motif").textContent = d.motif_used ?? "‚Äî";
        document.getElementById("st-valid").textContent = `${d.motifs_valides ?? 0}/${d.motifs_total ?? 0}`;

        const verdict = document.getElementById("st-verdict");
        verdict.textContent = d.verdict ?? "‚Äî";

        // Code couleur
        verdict.style.color = (d.verdict === "OK") ? "#4ade80" :
                              (d.verdict === "NOK") ? "#f87171" :
                              "#e5e7eb";

    } catch (e) {
        document.getElementById("st-verdict").textContent = "Hors ligne";
        document.getElementById("st-verdict").style.color = "#f87171";
    }
}

// üîÑ Mise √† jour IA toutes les 500 ms
setInterval(updateAIStats, 500);
updateAIStats();

</script>
