<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Surveillance IoT ‚Äì Gestion de Stock</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Police -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1d35 100%);
            color: #e0e6ed;
            min-height: 100vh;
            padding: 20px;
        }

        .container { max-width: 1400px; margin: 0 auto; }

        /* Header */
        header {
            background: linear-gradient(135deg, #1e2742 0%, #2a3251 100%);
            padding: 20px 24px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
            margin-bottom: 20px;
            border: 1px solid rgba(96,165,250,0.2);
        }

        header h1 {
            font-size: 26px;
            font-weight: 700;
            color: #60a5fa;
            margin-bottom: 4px;
        }

        header p {
            color: #94a3b8;
            font-size: 13px;
            font-weight: 300;
        }

        /* Tabs */
        .tabs {
            margin-top: 16px;
            display: flex;
            gap: 10px;
        }

        .tab-btn {
            border-radius: 999px;
            padding: 8px 18px;
            font-size: 13px;
            border: 1px solid rgba(148,163,184,0.4);
            background: rgba(15,23,42,0.8);
            color: #cbd5f5;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .tab-btn.active {
            background: #2563eb;
            color: #e5e7eb;
            border-color: #60a5fa;
            box-shadow: 0 0 18px rgba(37,99,235,0.6);
        }

        .tab-btn:hover { transform: translateY(-1px); }

        .tab-content { margin-top: 20px; }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }

        /* Layout grid & cards */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .card {
            background: linear-gradient(135deg, #1e2742 0%, #252d47 100%);
            border-radius: 15px;
            padding: 18px 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.35);
            border: 1px solid rgba(96,165,250,0.15);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 40px rgba(96,165,250,0.25);
        }

        .card h3 {
            font-size: 17px;
            font-weight: 600;
            margin-bottom: 10px;
            color: #60a5fa;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        <!-- ===================== SCAN QR & CONTROLE PALETTE ===================== -->
<div class="dashboard-grid" style="margin-top: 30px;">
    <div class="card" style="grid-column: span 2;">
        <h3>üì° Scan QR ‚Äì Contr√¥le palette</h3>

        <div class="info-grid" style="margin-top: 10px;">
            <div class="info-item">
                <label>Palette attendue (√† contr√¥ler)</label>
                <select id="scan-expected-palette" style="width:100%; padding:6px; border-radius:8px; border:none; background:#0f172a; color:#e5e7eb;">
                    <option value="">‚Äî Choisir une palette ‚Äî</option>
                </select>
            </div>

            <div class="info-item">
                <label>Scan code-barres</label>
                <input
                    id="scan-barcode-input"
                    type="text"
                    placeholder='Clique ici puis scanne le QR {"stockitem": 17}'
                    style="width:100%; padding:6px; border-radius:8px; border:none; background:#020617; color:#e5e7eb;">
                <div class="timestamp">Appuie sur Entr√©e apr√®s le scan si ton lecteur ne l‚Äôenvoie pas.</div>
            </div>
        </div>

        <div id="scan-result-card" class="info-item" style="margin-top:15px;">
            <label>R√©sultat du dernier scan</label>
            <div id="scan-result-text" class="timestamp">
                En attente de scan‚Ä¶
            </div>
        </div>
    </div>
</div>

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 18px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #1e2742 0%, #252d47 100%);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            border: 1px solid rgba(96,165,250,0.15);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }

        .stat-label {
            font-size: 11px;
            text-transform: uppercase;
            color: #64748b;
            font-weight: 600;
            letter-spacing: 0.06em;
        }

        .stat-value {
            font-size: 30px;
            font-weight: 700;
            color: #60a5fa;
            margin-top: 6px;
        }

        .progress-bar {
            width: 100%; height: 8px;
            background: rgba(15,22,41,0.8);
            border-radius: 10px;
            margin-top: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #22c55e 0%, #10b981 100%);
            border-radius: 10px;
            width: 0%;
            transition: width 0.4s ease;
        }

        /* Camera */
        .camera-preview {
            width: 100%;
            height: 260px;
            background: #0f172a;
            border-radius: 12px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border: 2px solid rgba(96,165,250,0.25);
        }

        .camera-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .camera-preview .placeholder {
            color: #64748b;
            font-size: 14px;
            text-align: center;
        }

        /* Palettes & status */
        .palette-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 999px;
            margin-bottom: 8px;
        }

        .status-ok {
            background: rgba(22,163,74,0.2);
            color: #4ade80;
            border: 1px solid rgba(22,163,74,0.9);
        }

        .status-error {
            background: rgba(239,68,68,0.2);
            color: #fecaca;
            border: 1px solid rgba(239,68,68,0.9);
        }

        .status-unknown {
            background: rgba(148,163,184,0.2);
            color: #e5e7eb;
            border: 1px solid rgba(148,163,184,0.9);
        }

        .info-grid {
            margin-top: 8px;
            display: grid;
            grid-template-columns: repeat(2, minmax(0,1fr));
            gap: 10px;
        }

        .info-item {
            background: rgba(15,23,42,0.6);
            padding: 8px 10px;
            border-radius: 8px;
            border: 1px solid rgba(51,65,85,0.9);
        }

        .info-item label {
            display: block;
            font-size: 10px;
            text-transform: uppercase;
            color: #64748b;
            letter-spacing: 0.08em;
            margin-bottom: 4px;
        }

        .info-item .value {
            font-size: 15px;
            font-weight: 600;
            color: #e5e7eb;
        }

        .items-list {
            margin-top: 10px;
            font-size: 13px;
        }

        .items-list div {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            border-bottom: 1px dashed rgba(51,65,85,0.5);
        }

        .items-list div:last-child { border-bottom: none; }

        .items-list span.name { color: #e5e7eb; }
        .items-list span.qty { color: #93c5fd; font-weight: 600; }
        .items-list span.expect { font-size: 11px; color: #9ca3af; margin-left: 6px; }

        .error-details {
            margin-top: 8px;
            font-size: 11px;
            color: #fecaca;
        }

        /* Scan panel */
        .scan-input {
            width: 100%;
            padding: 8px 10px;
            border-radius: 999px;
            border: 1px solid rgba(148,163,184,0.6);
            background: rgba(15,23,42,0.9);
            color: #e5e7eb;
            font-size: 13px;
            outline: none;
        }

        .scan-input:focus {
            border-color: #60a5fa;
            box-shadow: 0 0 12px rgba(37,99,235,0.6);
        }

        .scan-select {
            width: 100%;
            margin-top: 8px;
            padding: 6px 10px;
            border-radius: 999px;
            border: 1px solid rgba(148,163,184,0.6);
            background: rgba(15,23,42,0.9);
            color: #e5e7eb;
            font-size: 13px;
        }

        .scan-status {
            margin-top: 10px;
            padding: 8px 10px;
            border-radius: 10px;
            font-size: 13px;
        }

        .scan-status-neutral {
            background: rgba(30,64,175,0.2);
            border: 1px solid rgba(59,130,246,0.7);
            color: #bfdbfe;
        }

        .scan-status-ok {
            background: rgba(22,163,74,0.2);
            border: 1px solid rgba(34,197,94,0.9);
            color: #bbf7d0;
        }

        .scan-status-bad {
            background: rgba(239,68,68,0.2);
            border: 1px solid rgba(239,68,68,0.9);
            color: #fecaca;
        }

        .scan-meta {
            margin-top: 6px;
            font-size: 11px;
            color: #9ca3af;
        }

        /* Config tab */
        .config-help {
            font-size: 13px;
            color: #9ca3af;
            margin-bottom: 12px;
        }

        .config-card {
            background: linear-gradient(135deg, #020617 0%, #111827 100%);
            border-radius: 14px;
            padding: 14px 16px;
            border: 1px solid rgba(75,85,99,0.7);
            box-shadow: 0 10px 30px rgba(15,23,42,0.9);
        }

        .config-card h4 {
            font-size: 15px;
            margin-bottom: 6px;
            color: #bfdbfe;
        }

        .config-line {
            display: flex;
            gap: 6px;
            margin-top: 6px;
        }

        .config-line input[type="text"] {
            flex: 2;
            padding: 5px 8px;
            border-radius: 6px;
            border: 1px solid rgba(148,163,184,0.7);
            background: rgba(15,23,42,0.9);
            color: #e5e7eb;
            font-size: 13px;
        }

        .config-line input[type="number"] {
            width: 70px;
            padding: 5px 6px;
            border-radius: 6px;
            border: 1px solid rgba(148,163,184,0.7);
            background: rgba(15,23,42,0.9);
            color: #e5e7eb;
            font-size: 13px;
        }

        .config-btn {
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 11px;
            border: 1px solid rgba(148,163,184,0.8);
            background: rgba(15,23,42,0.9);
            color: #e5e7eb;
            cursor: pointer;
        }

        .config-btn.small { padding: 3px 8px; font-size: 11px; }

        .config-actions {
            margin-top: 8px;
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .config-save-all {
            margin-top: 14px;
            padding: 6px 14px;
            border-radius: 999px;
            border: 1px solid #22c55e;
            background: rgba(22,163,74,0.15);
            color: #bbf7d0;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
        }

        .config-save-all:hover { background: rgba(22,163,74,0.25); }

        @media (max-width: 768px) {
            header h1 { font-size: 22px; }
            .stat-value { font-size: 24px; }
        }
    </style>
</head>
<body>
<div class="container">
    <header>
        <h1>üé• Surveillance IoT ‚Äì Gestion de Stock</h1>
        <p>Raspberry Pi ¬∑ WebSocket temps r√©el ¬∑ Inventree ¬∑ ESP32-CAM</p>

        <!-- Onglets -->
        <div class="tabs">
            <button class="tab-btn active" data-tab="surveillance">Surveillance</button>
            <button class="tab-btn" data-tab="config">Configuration palettes</button>
        </div>
    </header>

    <div class="tab-content">

        <!-- ===================== TAB SURVEILLANCE ===================== -->
        <section id="tab-surveillance" class="tab-panel active">

            <!-- Stats globales -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Colis total d√©tect√©s</div>
                    <div class="stat-value" id="stat-total">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Nombre de palettes</div>
                    <div class="stat-value" id="stat-palettes">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Taux de remplissage</div>
                    <div class="stat-value" id="stat-fill">0%</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="fill-progress"></div>
                    </div>
                </div>
            </div>

            <div class="dashboard-grid">
                <!-- Cam√©ra -->
                <div class="card">
                    <h3>Cam√©ra entrep√¥t</h3>
                    <div class="camera-preview">
                        <img id="camera-stream" src="http://192.168.100.139:81/stream" alt="Flux cam√©ra" style="display:none;">
                        <div class="placeholder" id="camera-placeholder">
                            Connexion au flux vid√©o‚Ä¶<br>
                            192.168.100.139
                        </div>
                    </div>
                </div>

                <!-- Dernier scan -->
                <div class="card">
                    <h3>Dernier scan (Inventree)</h3>
                    <input
                        id="scan-input"
                        class="scan-input"
                        type="text"
                        placeholder="Place ton curseur ici et scanne un QR / code-barres..."
                        autocomplete="off"
                    >
                    <select id="scan-palette-select" class="scan-select">
                        <option value="">Palette cible (s√©lectionne une palette)</option>
                    </select>

                    <div id="scan-status" class="scan-status scan-status-neutral">
                        En attente de scan‚Ä¶
                    </div>

                    <div id="scan-meta" class="scan-meta">
                        Aucun scan re√ßu pour le moment.
                    </div>
                </div>
            </div>

            <!-- Palettes -->
            <h3 style="margin: 10px 2px 8px;">Palettes & contenu (Inventree)</h3>
            <div class="dashboard-grid" id="palettes-container">
                <!-- Rempli dynamiquement -->
            </div>
        </section>

        <!-- ===================== TAB CONFIG ===================== -->
        <section id="tab-config" class="tab-panel">
            <p class="config-help">
                Ici tu d√©finis <strong>la r√©partition attendue</strong> des cartons par palette.<br>
                Le syst√®me v√©rifiera ensuite en temps r√©el et affichera ‚úî/‚ùå dans l‚Äôonglet <em>Surveillance</em>,
                et aussi pour chaque <strong>scan</strong>.
            </p>

            <div class="dashboard-grid" id="config-container">
                <!-- Rempli dynamiquement -->
            </div>

            <button class="config-save-all" id="btn-save-config">
                üíæ Enregistrer la configuration (localStorage navigateur)
            </button>
        </section>
    </div>
</div>

<script>
    console.log("Connexion WebSocket‚Ä¶");

    const ws = new WebSocket("ws://192.168.100.112:8765");

    // R√®gles palettes -> cartons attendus
    // Aliment√© depuis ta fen√™tre de config palettes (paletteConfig),
    // ici on r√©cup√®re ce qui est stock√© en localStorage si pr√©sent.
    let paletteRules = {};
    try {
        paletteRules = JSON.parse(localStorage.getItem("paletteRules") || "{}");
    } catch (e) {
        paletteRules = {};
    }

    // M√©morise les palettes courantes pour le select
    let currentPalettes = [];

    function savePaletteRules() {
        localStorage.setItem("paletteRules", JSON.stringify(paletteRules));
    }

    // Remplit les <select> de palette (scan + √©ventuelle config)
    function updatePaletteSelectOptions(palettes) {
        currentPalettes = palettes;
        const scanSelect = document.getElementById("scan-expected-palette");
        if (!scanSelect) return;

        const currentValue = scanSelect.value;
        scanSelect.innerHTML = '<option value="">‚Äî Choisir une palette ‚Äî</option>';

        palettes.forEach(p => {
            const opt = document.createElement("option");
            opt.value = p.name;
            opt.textContent = p.name;
            scanSelect.appendChild(opt);
        });

        // essaie de garder la valeur pr√©c√©dente si elle existe encore
        if (currentValue) {
            scanSelect.value = currentValue;
        }
    }

    // Mise en forme du r√©sultat de scan
    function highlightPalette(expectedPalette) {
        // enl√®ve le highlight existant
        document.querySelectorAll(".inv-card").forEach(card => {
            card.style.boxShadow = "";
            card.style.borderColor = "rgba(55, 65, 81, 0.95)";
        });

        if (!expectedPalette) return;

        const card = document.querySelector(`.inv-card[data-palette-name="${expectedPalette}"]`);
        if (card) {
            card.style.boxShadow = "0 0 25px rgba(34, 197, 94, 0.7)";
            card.style.borderColor = "#22c55e";
        }
    }

    function handleScanResult(scan) {
        const resultDiv = document.getElementById("scan-result-text");
        if (!resultDiv) return;

        if (scan.error) {
            resultDiv.innerHTML = `‚ùå Erreur lors du scan : <span style="color:#f97373;">${scan.error}</span>`;
            highlightPalette(null);
            return;
        }

        const expectedPalette = document.getElementById("scan-expected-palette").value;
        const article = scan.article || "(article inconnu)";
        const paletteActuelle = scan.palette_actuelle || "(palette inconnue)";

        const rules = window.paletteRules || {};
        const expectedArticles = rules[expectedPalette] || [];

        let doitEtreIci = null;
        if (expectedPalette && expectedArticles.length > 0) {
            // true si l‚Äôarticle fait partie de la liste attendue
            doitEtreIci = expectedArticles.includes(article);
        }

        let message = `
            üì¶ Article scann√© : <strong>${article}</strong><br>
            üìç Palette InvenTree actuelle : <strong>${paletteActuelle}</strong><br>
            üéØ Palette attendue (s√©lectionn√©e) : <strong>${expectedPalette || "‚Äî"}</strong><br>
        `;

        if (!expectedPalette) {
            message += `<br><span style="color:#fbbf24;">S√©lectionne une palette √† contr√¥ler pour savoir s‚Äôil doit y √™tre.</span>`;
            highlightPalette(null);
        } else if (doitEtreIci === null) {
            message += `<br><span style="color:#fbbf24;">Aucune r√®gle d√©finie pour ${expectedPalette} dans la configuration palettes.</span>`;
            highlightPalette(expectedPalette);
        } else if (doitEtreIci) {
            message += `<br><span style="color:#22c55e; font-weight:600;">‚úî Cet article est attendu sur cette palette.</span>`;
            highlightPalette(expectedPalette);
        } else {
            message += `<br><span style="color:#f97373; font-weight:600;">‚ùå Cet article ne fait pas partie des cartons attendus pour cette palette.</span>`;
            highlightPalette(expectedPalette);
        }

        resultDiv.innerHTML = message;
    }

    // Gestion WebSocket
    ws.onopen = () => {
        console.log("WebSocket connect√© !");
        // Premier refresh
        ws.send(JSON.stringify({ action: "refresh_inventory" }));
        // Refresh r√©gulier toutes les 10s
        setInterval(() => {
            ws.send(JSON.stringify({ action: "refresh_inventory" }));
        }, 10000);
    };

    ws.onerror = (err) => {
        console.error("Erreur WebSocket", err);
    };

    ws.onclose = () => {
        console.warn("WebSocket ferm√©");
    };

    ws.onmessage = (event) => {
        const msg = JSON.parse(event.data);

        // Inventaire complet (palettes)
        if (msg.inventree && msg.inventree.palettes) {
            const palettes = msg.inventree.palettes;
            // ta fonction de rendu des palettes
            generateInventreeCards(palettes);
            updatePaletteSelectOptions(palettes);
        }

        // R√©sultat d‚Äôun scan
        if (msg.scan) {
            handleScanResult(msg.scan);
        }
    };

    // ======================== GESTION DU CHAMP DE SCAN ========================

    const scanInput = document.getElementById("scan-barcode-input");
    if (scanInput) {
        scanInput.addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
                const raw = scanInput.value.trim();
                if (!raw) return;
                ws.send(JSON.stringify({
                    action: "scan_barcode",
                    barcode: raw
                }));
                // on garde le code dans le champ pour debug, ou tu peux le vider :
                // scanInput.value = "";
            }
        });
    }

    // ======================== HOOK AVEC TA FEN√äTRE CONFIG PALETTES ========================
    // Id√©e : quand tu modifies ta config depuis la fen√™tre palettes, tu mets √† jour
    // window.paletteRules puis tu appelles savePaletteRules().
    // Exemple :
    //   window.paletteRules["PALETTE 1"] = ["CARTON A", "CARTON B"];
    //   savePaletteRules();
</script>

</body>
</html>
