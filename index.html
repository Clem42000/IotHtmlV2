<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<title>Surveillance IoT â€“ Dashboard EntrepÃ´t</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet" />

<style>
/* --------------------------
   GLOBAL
--------------------------- */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: "Poppins", sans-serif;
    background: radial-gradient(circle at 20% 20%, #11162e 0%, #0a0d1f 100%);
    color: #e0e6f0;
    padding: 20px;
}

/* Glow subtle */
.glow {
    box-shadow: 0 0 25px rgba(90, 140, 255, 0.15);
}

.container {
    max-width: 1450px;
    margin: auto;
}

/* --------------------------
   HEADER
--------------------------- */
header {
    background: rgba(20, 28, 55, 0.75);
    padding: 26px 30px;
    border-radius: 18px;
    backdrop-filter: blur(12px);
    border: 1px solid rgba(120, 160, 255, 0.15);
    margin-bottom: 25px;
    transition: 0.25s;
}
header:hover {
    transform: translateY(-3px);
}

header h1 {
    font-size: 30px;
    font-weight: 700;
    color: #6da8ff;
    margin-bottom: 6px;
}

/* Tabs */
.tabs {
    margin-top: 18px;
    display: flex;
    gap: 12px;
}

.tab-btn {
    padding: 8px 20px;
    border-radius: 999px;
    border: 1px solid rgba(130, 150, 200, 0.35);
    background: rgba(10, 15, 30, 0.65);
    color: #cfd9fc;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.25s ease;
}
.tab-btn:hover {
    transform: translateY(-2px);
}
.tab-btn.active {
    background: linear-gradient(135deg, #2962ff, #3b82f6);
    color: white;
    border-color: transparent;
    box-shadow: 0 0 15px rgba(41, 98, 255, 0.4);
}

/* --------------------------
   CARDS
--------------------------- */
.card {
    background: rgba(20, 28, 55, 0.65);
    border-radius: 16px;
    padding: 20px;
    border: 1px solid rgba(120, 160, 255, 0.12);
    backdrop-filter: blur(10px);
    transition: 0.25s;
}
.card:hover {
    transform: translateY(-4px);
    box-shadow: 0 0 25px rgba(90, 140, 255, 0.2);
}

.card h3 {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 14px;
    color: #7db4ff;
}

/* Grid */
.dashboard-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(330px, 1fr));
    gap: 20px;
}

/* --------------------------
   STATS CARDS
--------------------------- */
.stat-card {
    background: rgba(25, 32, 60, 0.75);
    padding: 22px;
    border-radius: 16px;
    border: 1px solid rgba(120, 160, 255, 0.15);
    text-align: center;
    transition: 0.25s ease;
}
.stat-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 0 20px rgba(90, 140, 255, 0.25);
}

.stat-label {
    font-size: 12px;
    text-transform: uppercase;
    color: #7b89a8;
    letter-spacing: 0.07em;
}

.stat-value {
    font-size: 34px;
    margin-top: 8px;
    font-weight: 700;
    color: #8bb8ff;
}

/* --------------------------
   CAMERA
--------------------------- */
.camera-preview {
    width: 100%;
    height: 260px;
    border-radius: 14px;
    overflow: hidden;
    border: 1px solid rgba(120, 160, 255, 0.25);
    background: #0f162e;
}

.camera-preview img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

/* --------------------------
   PALETTES
--------------------------- */
.palette-status {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 4px 12px;
    font-size: 12px;
    border-radius: 999px;
    margin-bottom: 10px;
}

.status-ok {
    background: rgba(0, 190, 80, 0.2);
    color: #67ffb5;
    border: 1px solid rgba(0, 200, 90, 0.6);
}

.status-error {
    background: rgba(255, 75, 75, 0.25);
    color: #ffbcbc;
    border: 1px solid rgba(255, 110, 110, 0.7);
}

.status-unknown {
    background: rgba(120, 130, 150, 0.25);
    color: #d0d3e2;
    border: 1px solid rgba(160, 170, 190, 0.6);
}

.info-item {
    background: rgba(15, 20, 40, 0.6);
    border: 1px solid rgba(70, 80, 110, 0.7);
    border-radius: 10px;
    padding: 10px;
}

.items-list {
    margin-top: 14px;
    font-size: 14px;
}

.items-list div {
    display: flex;
    justify-content: space-between;
    padding: 5px 0;
    border-bottom: 1px dashed rgba(70, 90, 130, 0.5);
}

.error-details {
    margin-top: 10px;
    color: #ffbdbd;
    font-size: 12px;
}

/* --------------------------
   CONFIG
--------------------------- */
.config-card {
    background: rgba(10, 14, 30, 0.75);
    padding: 16px;
    border-radius: 14px;
    border: 1px solid rgba(140, 150, 200, 0.35);
}

.config-btn {
    padding: 6px 14px;
    border-radius: 999px;
    background: rgba(45, 60, 110, 0.7);
    border: 1px solid rgba(140, 150, 200, 0.4);
    color: #d5defc;
    cursor: pointer;
    font-size: 13px;
}
.config-btn:hover {
    background: rgba(70, 85, 145, 0.7);
}

.config-save-all {
    margin-top: 16px;
    padding: 8px 18px;
    border-radius: 999px;
    background: rgba(0, 160, 90, 0.2);
    border: 1px solid #10c26e;
    color: #b6ffd6;
    font-weight: 600;
}

/* --------------------------
   RESPONSIVE
--------------------------- */
@media (max-width: 768px) {
    header h1 {
        font-size: 22px;
    }
    .stat-value {
        font-size: 26px;
    }
}
</style>
</head>

<body>
<div class="container">

<header class="glow">
    <h1>ðŸŽ¥ Dashboard IoT â€“ EntrepÃ´t</h1>
    <p>Inventree Â· ESP32-CAM Â· WebSocket temps rÃ©el Â· Raspberry Pi</p>

    <div class="tabs">
        <button class="tab-btn active" data-tab="surveillance">Surveillance</button>
        <button class="tab-btn" data-tab="config">Configuration palettes</button>
    </div>
</header>

<div class="tab-content">

<!-- ------------------------------------------------------
    SURVEILLANCE
------------------------------------------------------ -->
<section id="tab-surveillance" class="tab-panel active">

    <!-- Stats -->
    <div class="dashboard-grid">
        <div class="stat-card glow">
            <div class="stat-label">Colis total dÃ©tectÃ©s</div>
            <div class="stat-value" id="stat-total">0</div>
        </div>
        <div class="stat-card glow">
            <div class="stat-label">Nombre de palettes</div>
            <div class="stat-value" id="stat-palettes">0</div>
        </div>
        <div class="stat-card glow">
            <div class="stat-label">Taux de remplissage</div>
            <div class="stat-value" id="stat-fill">0%</div>
        </div>
    </div>

    <!-- CamÃ©ra -->
    <div class="dashboard-grid">
        <div class="card glow">
            <h3>CamÃ©ra entrepÃ´t</h3>
            <div class="camera-preview">
                <img id="camera-stream" src="http://192.168.100.139:81/stream" />
            </div>
        </div>
    </div>

    <h3 style="margin:20px 0 10px;">ðŸ“¦ Palettes & contenu</h3>

    <div class="dashboard-grid" id="palettes-container"></div>

</section>

<!-- ------------------------------------------------------
    CONFIG
------------------------------------------------------ -->
<section id="tab-config" class="tab-panel">

    <p style="color:#c4d3fa; margin-bottom:12px;">
        DÃ©finis ici les cartons attendus sur chaque palette.<br>
        Les erreurs seront visibles dans l'onglet <strong>Surveillance</strong>.
    </p>

    <div class="dashboard-grid" id="config-container"></div>

    <button class="config-save-all glow" id="btn-save-config">
        ðŸ’¾ Enregistrer la configuration
    </button>

</section>

</div><!-- /tab-content -->
</div><!-- /container -->

<script>
/* --------------------------
   TABS
--------------------------- */
const tabButtons = document.querySelectorAll(".tab-btn");
const tabPanels = document.querySelectorAll(".tab-panel");

tabButtons.forEach(btn => {
    btn.addEventListener("click", () => {
        tabButtons.forEach(b => b.classList.remove("active"));
        btn.classList.add("active");

        tabPanels.forEach(p => {
            p.classList.remove("active");
            if (p.id === "tab-" + btn.dataset.tab) p.classList.add("active");
        });
    });
});

/* --------------------------
   CAMERA AUTO REFRESH
--------------------------- */
setInterval(() => {
    document.getElementById("camera-stream").src =
        "http://192.168.100.139:81/stream?ts=" + Date.now();
}, 15000);

/* --------------------------
   WEBSOCKET
--------------------------- */
const ws = new WebSocket("ws://192.168.100.112:8765");

let lastPalettes = [];
let palettesConfig = {};

function loadConfig() {
    const raw = localStorage.getItem("palettesConfig");
    palettesConfig = raw ? JSON.parse(raw) : {};
}
loadConfig();

ws.onmessage = e => {
    const msg = JSON.parse(e.data);

    if (msg.inventree) {
        lastPalettes = msg.inventree.palettes;
        updateDashboard();
    }
};

/* --------------------------
   UPDATE DASHBOARD
--------------------------- */
function updateDashboard() {
    let total = 0;
    lastPalettes.forEach(p => total += p.total_qty || 0);

    document.getElementById("stat-total").textContent = total;
    document.getElementById("stat-palettes").textContent = lastPalettes.length;

    const fill = Math.min(100, Math.round(total));
    document.getElementById("stat-fill").textContent = fill + "%";

    renderPalettes();
    renderConfig();
}

/* --------------------------
   PALETTE COMPLIANCE
--------------------------- */
function computeCompliance(palette) {
    const expected = palettesConfig[palette.name] || {};
    const actual = {};

    (palette.items || []).forEach(it => {
        const n = it.name;
        const q = Number(it.qty || 0);
        actual[n] = (actual[n] || 0) + q;
    });

    let ok = true;
    let errors = [];

    for (let n in expected) {
        if ((actual[n] || 0) < expected[n]) {
            ok = false;
            errors.push(`Manque ${expected[n] - actual[n]} Ã— ${n}`);
        }
    }

    for (let n in actual) {
        if (!expected[n]) {
            ok = false;
            errors.push(`Non prÃ©vu : ${n}`);
        }
    }

    if (Object.keys(expected).length === 0) return { status: "unknown", errors: [] };
    return { status: ok ? "ok" : "error", errors };
}

/* --------------------------
   RENDER SURVEILLANCE
--------------------------- */
function renderPalettes() {
    const container = document.getElementById("palettes-container");
    container.innerHTML = "";

    lastPalettes.forEach(p => {
        const { status, errors } = computeCompliance(p);

        let sClass = "status-unknown";
        let sText = "Aucune configuration";

        if (status === "ok") { sClass = "status-ok"; sText = "Conforme"; }
        if (status === "error") { sClass = "status-error"; sText = "Non conforme"; }

        let list = "";
        p.items.forEach(it => {
            list += `
                <div>
                    <span>${it.name}</span>
                    <span>${it.qty || 0}</span>
                </div>`;
        });

        const div = document.createElement("div");
        div.className = "card glow";
        div.innerHTML = `
            <h3>${p.name}</h3>
            <div class="palette-status ${sClass}">${sText}</div>

            <div class="info-item">
                <strong>Total :</strong> ${p.total_qty}
            </div>

            <div class="items-list">${list}</div>

            ${errors.length ? `<div class="error-details">${errors.join("<br>")}</div>` : ""}
        `;
        container.appendChild(div);
    });
}

/* --------------------------
   RENDER CONFIG
--------------------------- */
function renderConfig() {
    const container = document.getElementById("config-container");
    container.innerHTML = "";

    lastPalettes.forEach(p => {
        const cfg = palettesConfig[p.name] || {};

        let fields = "";
        Object.keys(cfg).forEach(item => {
            fields += configLine(p.name, item, cfg[item]);
        });

        if (!Object.keys(cfg).length)
            fields += configLine(p.name, "", "");

        const div = document.createElement("div");
        div.className = "config-card glow";
        div.innerHTML = `
            <h3>${p.name}</h3>
            <div class="config-lines" data-palette="${p.name}">
                ${fields}
            </div>
            <button class="config-btn" onclick="addLine('${p.name}')">+ Ajouter</button>
        `;
        container.appendChild(div);
    });
}

function configLine(palette, name, qty) {
    return `
        <div style="display:flex;gap:8px;margin-top:8px;">
            <input type="text" class="cfg-name" data-palette="${palette}" value="${name}" placeholder="Nom">
            <input type="number" class="cfg-qty" data-palette="${palette}" value="${qty}" min="0" style="width:80px;">
        </div>`;
}

function addLine(pName) {
    const div = document.querySelector(`.config-lines[data-palette="${pName}"]`);
    div.insertAdjacentHTML("beforeend", configLine(pName, "", ""));
}

/* --------------------------
   SAVE CONFIG
--------------------------- */
document.getElementById("btn-save-config").onclick = () => {
    const inputs = document.querySelectorAll(".cfg-name");
    palettesConfig = {};

    inputs.forEach(inp => {
        const palette = inp.dataset.palette;
        const qty = document.querySelector(`.cfg-qty[data-palette="${palette}"]`);
    });

    const cards = document.querySelectorAll(".config-card");
    cards.forEach(card => {
        const pname = card.querySelector(".config-lines").dataset.palette;
        palettesConfig[pname] = {};

        const lines = card.querySelectorAll("input");
        for (let i = 0; i < lines.length; i += 2) {
            const n = lines[i].value.trim();
            const q = Number(lines[i + 1].value || 0);
            if (n && q > 0) palettesConfig[pname][n] = q;
        }
    });

    localStorage.setItem("palettesConfig", JSON.stringify(palettesConfig));
    alert("Configuration sauvegardÃ©e âœ”");
};
</script>

</body>
</html>
